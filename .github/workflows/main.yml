name: iOS CI/CD Build (Manual Signing Fix)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: macos-15 # ä½¿ç”¨æœ€æ–°çš„ macOS çŽ¯å¢ƒ
    
    steps:
      - name: Checkout project
        uses: actions/checkout@v4

      # 1. å®‰è£…è¯ä¹¦å’Œæè¿°æ–‡ä»¶ (å¢žåŠ  -A å‚æ•°å’Œæœç´¢è·¯å¾„ä¿®å¤)
      - name: Install the Apple certificate and provisioning profile
        env:
          P12_BASE64: ${{ secrets.P12_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          PROVISIONING_BASE64: ${{ secrets.PROVISIONING_BASE64 }}
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 21)

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # å¯¼å…¥ P12 è¯ä¹¦ (-A å…è®¸æ‰€æœ‰åº”ç”¨è®¿é—®ç§é’¥ï¼Œé˜²æ­¢ codesign å¼¹å‡ºæƒé™æ¡†)
          echo "$P12_BASE64" | base64 -D > $RUNNER_TEMP/cert.p12
          security import $RUNNER_TEMP/cert.p12 -k "$KEYCHAIN_PATH" -P "$P12_PASSWORD" -A -T /usr/bin/codesign -T /usr/bin/productsign
          
          # å…³é”®ï¼šè®¾ç½® Keychain æœç´¢åˆ—è¡¨ï¼Œç¡®ä¿ç³»ç»Ÿä¼˜å…ˆæŸ¥æ‰¾æ­¤é’¥åŒ™æ‰£
          security list-keychains -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | xargs)
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # å¯¼å…¥æè¿°æ–‡ä»¶
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$PROVISIONING_BASE64" | base64 -D > ~/Library/MobileDevice/Provisioning\ Profiles/al10test.mobileprovision
          
          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app # æ ¹æ®éœ€è¦é€‰æ‹©ç‰ˆæœ¬

      # 2. è®¾ç½®é¡¹ç›®å˜é‡
      - name: Prepare Build Variables
        run: |
          PROJECT_PATH=$(ls -d *.xcodeproj | head -n 1)
          PROJECT_NAME=$(basename "$PROJECT_PATH" .xcodeproj)
          SCHEME_NAME=$(xcodebuild -list -json -project "$PROJECT_PATH" | python3 -c 'import json, sys; d = json.load(sys.stdin); s = d.get("project", {}).get("schemes", []); print(s[0] if s else "")')
          NEW_BUILD_NUMBER=$(date +"%Y%m%d%H%M")
          
          echo "PROJECT_PATH=$PROJECT_PATH" >> $GITHUB_ENV
          echo "PROJECT_NAME=$PROJECT_NAME" >> $GITHUB_ENV
          echo "SCHEME_NAME=$SCHEME_NAME" >> $GITHUB_ENV
          echo "NEW_BUILD_NUMBER=$NEW_BUILD_NUMBER" >> $GITHUB_ENV

      # 3. è§£æž Swift Packages
      - name: Resolve Swift Packages
        run: |
          xcodebuild -resolvePackageDependencies \
            -project "${{ env.PROJECT_PATH }}" \
            -scheme "${{ env.SCHEME_NAME }}" \
            -configuration Release

      # 4. æ›´æ–° Build å·
      - name: Update Build Number
        run: |
          xcrun agvtool new-version -all "${{ env.NEW_BUILD_NUMBER }}"

      # 5. Archive (å¢žåŠ æ˜¾å¼ç­¾åå‚æ•°ï¼Œé˜²æ­¢ç”Ÿæˆâ€œç©ºç­¾åâ€çš„ Archive)
      - name: Build Archive
        run: |
          mkdir -p build
          xcodebuild archive \
            -project "${{ env.PROJECT_PATH }}" \
            -scheme "${{ env.SCHEME_NAME }}" \
            -configuration Release \
            -sdk iphoneos \
            -archivePath ./build/${{ env.PROJECT_NAME }}.xcarchive \
            -allowProvisioningUpdates \

      # 6. å¯¼å‡º IPA (å¢žåŠ çŽ¯å¢ƒç¼–ç å’Œé”™è¯¯æ£€æŸ¥)
      - name: Export IPA
        run: |
          export LANG=en_US.UTF-8
          export LC_ALL=en_US.UTF-8
          
          # æ‰“å°èº«ä»½ä¿¡æ¯ç”¨äºŽè°ƒè¯•ï¼Œè‹¥æ˜¾ç¤º 0 identities åˆ™ P12 æœ‰è¯¯
          security find-identity -v -p codesigning ${{ env.KEYCHAIN_PATH }}
          
          rm -rf ./build/ipa
          mkdir -p ./build/ipa
          
          xcodebuild -exportArchive \
            -archivePath ./build/${{ env.PROJECT_NAME }}.xcarchive \
            -exportPath ./build/ipa \
            -exportOptionsPlist ./exportOptions.plist \
            -allowProvisioningUpdates

      # 7. ä¸Šä¼ åˆ°è’²å…¬è‹±
      - name: Upload to Pgyer
        env:
          PGY_API_KEY: ${{ secrets.PGY_API_KEY }}
          PGY_USER_KEY: ${{ secrets.PGY_USER_KEY }}
        run: |
          IPA_PATH=$(find ./build/ipa -name "*.ipa" | head -n 1)
          if [ -z "$IPA_PATH" ]; then
            echo "âŒ IPA not found!"
            exit 1
          fi
          
          RESPONSE=$(curl -s -F "file=@${IPA_PATH}" \
               -F "uKey=${PGY_USER_KEY}" \
               -F "_api_key=${PGY_API_KEY}" \
               https://www.pgyer.com/apiv2/app/upload)
               
          echo "Pgyer Response: $RESPONSE"
          DOWNLOAD_URL=$(echo "$RESPONSE" | python3 -c 'import sys, json; print(json.load(sys.stdin)["data"]["buildShortcutUrl"])' 2>/dev/null)
          echo "ðŸŽ‰ App Uploaded! URL: https://www.pgyer.com/$DOWNLOAD_URL"
