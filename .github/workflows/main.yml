name: iOS CI/CD Build (Profile Fix)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-15
    
    steps:
      - name: Checkout project
        uses: actions/checkout@v4

      # 1. å®‰è£…è¯ä¹¦å’Œæè¿°æ–‡ä»¶ (å¢žå¼ºç‰ˆï¼šè‡ªåŠ¨è¯†åˆ« UUID)
      - name: Install the Apple certificate and provisioning profile
        env:
          P12_BASE64: ${{ secrets.P12_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          PROVISIONING_BASE64: ${{ secrets.PROVISIONING_BASE64 }}
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 21)
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # å¯¼å…¥ P12
          echo "$P12_BASE64" | base64 -D > $RUNNER_TEMP/cert.p12
          security import $RUNNER_TEMP/cert.p12 -k "$KEYCHAIN_PATH" -P "$P12_PASSWORD" -A -T /usr/bin/codesign -T /usr/bin/productsign
          security list-keychains -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | xargs)
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # å¯¼å…¥æè¿°æ–‡ä»¶å¹¶é‡å‘½åä¸º UUID (ç¡®ä¿ Xcode 100% èƒ½æ‰¾åˆ°)
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$PROVISIONING_BASE64" | base64 -D > $RUNNER_TEMP/temp.mobileprovision
          UUID=$(mobileprovision-read -f $RUNNER_TEMP/temp.mobileprovision -o UUID)
          cp $RUNNER_TEMP/temp.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$UUID.mobileprovision
          
          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV

      # 2. å‡†å¤‡å˜é‡
      - name: Prepare Build Variables
        run: |
          PROJECT_PATH=$(ls -d *.xcodeproj | head -n 1)
          PROJECT_NAME=$(basename "$PROJECT_PATH" .xcodeproj)
          SCHEME_NAME=$(xcodebuild -list -json -project "$PROJECT_PATH" | python3 -c 'import json, sys; d = json.load(sys.stdin); s = d.get("project", {}).get("schemes", []); print(s[0] if s else "")')
          NEW_BUILD_NUMBER=$(date +"%Y%m%d%H%M")
          echo "PROJECT_PATH=$PROJECT_PATH" >> $GITHUB_ENV
          echo "PROJECT_NAME=$PROJECT_NAME" >> $GITHUB_ENV
          echo "SCHEME_NAME=$SCHEME_NAME" >> $GITHUB_ENV
          echo "NEW_BUILD_NUMBER=$NEW_BUILD_NUMBER" >> $GITHUB_ENV

      # 3. è§£æžä¾èµ–
      - name: Resolve Swift Packages
        run: xcodebuild -resolvePackageDependencies -project "${{ env.PROJECT_PATH }}" -scheme "${{ env.SCHEME_NAME }}" -configuration Release

      # 4. æ›´æ–°ç‰ˆæœ¬å·
      - name: Update Build Number
        run: xcrun agvtool new-version -all "${{ env.NEW_BUILD_NUMBER }}"

      # 5. Archive (åŠ¡å¿…ç§»é™¤ SKIP_INSTALLï¼Œç¡®ä¿ç”Ÿæˆæ­£ç¡®çš„äºŒè¿›åˆ¶åŒ…)
      - name: Build Archive
        run: |
          mkdir -p build
          xcodebuild archive \
            -project "${{ env.PROJECT_PATH }}" \
            -scheme "${{ env.SCHEME_NAME }}" \
            -configuration Release \
            -sdk iphoneos \
            -archivePath ./build/${{ env.PROJECT_NAME }}.xcarchive \
            -allowProvisioningUpdates \
            DEVELOPMENT_TEAM="F7XLR9JPD6" \
            CODE_SIGN_STYLE="Manual" \
            PROVISIONING_PROFILE_SPECIFIER="al10test" \
            CODE_SIGN_IDENTITY="Apple Development"

      # 6. å¯¼å‡º IPA
      - name: Export IPA
        run: |
          # ç¡®ä¿å¯¼å‡ºçŽ¯å¢ƒå¯ä»¥çœ‹åˆ° Keychain
          security list-keychains -d user -s ${{ env.KEYCHAIN_PATH }}
          
          xcodebuild -exportArchive \
            -archivePath ./build/${{ env.PROJECT_NAME }}.xcarchive \
            -exportPath ./build/ipa \
            -exportOptionsPlist ./exportOptions.plist \
            -allowProvisioningUpdates \
            -verbose

      # 7. ä¸Šä¼ 
      - name: Upload to Pgyer
        env:
          PGY_API_KEY: ${{ secrets.PGY_API_KEY }}
          PGY_USER_KEY: ${{ secrets.PGY_USER_KEY }}
        run: |
          IPA_PATH=$(find ./build/ipa -name "*.ipa" | head -n 1)
          RESPONSE=$(curl -s -F "file=@${IPA_PATH}" -F "uKey=${PGY_USER_KEY}" -F "_api_key=${PGY_API_KEY}" https://www.pgyer.com/apiv2/app/upload)
          DOWNLOAD_URL=$(echo "$RESPONSE" | python3 -c 'import sys, json; print(json.load(sys.stdin)["data"]["buildShortcutUrl"])' 2>/dev/null)
          echo "ðŸŽ‰ App Uploaded! URL: https://www.pgyer.com/$DOWNLOAD_URL"
