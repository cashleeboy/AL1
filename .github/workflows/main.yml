name: iOS CI/CD Build

on:
  push:
    branches: [ "main" ] # å½“ main åˆ†æ”¯æœ‰æŽ¨é€æ—¶è§¦å‘
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: macos-15 # ä½¿ç”¨æœ€æ–°çš„ macOS çŽ¯å¢ƒ
    
    steps:
      - name: Checkout project
        uses: actions/checkout@v4

      # 1. å®‰è£…è¯ä¹¦å’Œæè¿°æ–‡ä»¶ (GitHub Actions è¿è¡ŒçŽ¯å¢ƒæ˜¯å¹²å‡€çš„ï¼Œå¿…é¡»æ‰‹åŠ¨å¯¼å…¥)
      - name: Install the Apple certificate and provisioning profile
        env:
          P12_BASE64: ${{ secrets.P12_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          PROVISIONING_BASE64: ${{ secrets.PROVISIONING_BASE64 }}
        run: |
          # åˆ›å»ºä¸´æ—¶é’¥åŒ™æ‰£
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 21)
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # å¯¼å…¥ P12 è¯ä¹¦
          echo $P12_BASE64 | base64 --decode > $RUNNER_TEMP/cert.p12
          security import $RUNNER_TEMP/cert.p12 -k "$KEYCHAIN_PATH" -P "$P12_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # å¯¼å…¥æè¿°æ–‡ä»¶
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo $PROVISIONING_BASE64 | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/temp.mobileprovision

      # 2. è®¾ç½®é¡¹ç›®å˜é‡ (å¤ç”¨ä½ åŽŸè„šæœ¬çš„é€»è¾‘)
      - name: Prepare Build Variables
        run: |
          PROJECT_PATH=$(ls -d *.xcodeproj | head -n 1)
          PROJECT_NAME=$(basename "$PROJECT_PATH" .xcodeproj)
          SCHEME_NAME=$(xcodebuild -list -json -project "$PROJECT_PATH" | python3 -c 'import json, sys; d = json.load(sys.stdin); s = d.get("project", {}).get("schemes", []); print(s[0] if s else "")')
          NEW_BUILD_NUMBER=$(date +"%Y%m%d%H%M")
          
          # å°†å˜é‡å†™å…¥çŽ¯å¢ƒå˜é‡ï¼Œä¾›åŽç»­æ­¥éª¤ä½¿ç”¨
          echo "PROJECT_PATH=$PROJECT_PATH" >> $GITHUB_ENV
          echo "PROJECT_NAME=$PROJECT_NAME" >> $GITHUB_ENV
          echo "SCHEME_NAME=$SCHEME_NAME" >> $GITHUB_ENV
          echo "NEW_BUILD_NUMBER=$NEW_BUILD_NUMBER" >> $GITHUB_ENV

      # 3. æ›´æ–° Build å·
      - name: Update Build Number
        run: |
          xcrun agvtool new-version -all "$NEW_BUILD_NUMBER"

      # 4. Archive å¹¶æž„å»º
      - name: Build Archive
        run: |
          xcodebuild archive \
            -project "${{ env.PROJECT_PATH }}" \
            -scheme "${{ env.SCHEME_NAME }}" \
            -configuration Release \
            -sdk iphoneos \
            -archivePath ./build/${{ env.PROJECT_NAME }}.xcarchive \
            -allowProvisioningUpdates

      # 5. å¯¼å‡º IPA
      - name: Export IPA
        run: |
          xcodebuild -exportArchive \
            -archivePath ./build/${{ env.PROJECT_NAME }}.xcarchive \
            -exportPath ./build/ipa \
            -exportOptionsPlist ./exportOptions.plist \
            -allowProvisioningUpdates

      # 6. ä¸Šä¼ åˆ°è’²å…¬è‹±
      - name: Upload to Pgyer
        env:
          PGY_API_KEY: ${{ secrets.PGY_API_KEY }}
          PGY_USER_KEY: ${{ secrets.PGY_USER_KEY }}
        run: |
          IPA_PATH=$(find ./build/ipa -name "*.ipa" | head -n 1)
          echo "ðŸš€ Uploading $IPA_PATH to Pgyer..."
          
          RESPONSE=$(curl -s -F "file=@${IPA_PATH}" \
               -F "uKey=${PGY_USER_KEY}" \
               -F "_api_key=${PGY_API_KEY}" \
               https://www.pgyer.com/apiv2/app/upload)
               
          echo "Pgyer Response: $RESPONSE"
          DOWNLOAD_URL=$(echo "$RESPONSE" | python3 -c 'import sys, json; print(json.load(sys.stdin)["data"]["buildShortcutUrl"])' 2>/dev/null)
          echo "ðŸŽ‰ App Uploaded! URL: https://www.pgyer.com/$DOWNLOAD_URL"