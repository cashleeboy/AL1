name: iOS CI/CD Build

on:
  push:
    branches: [ "main" ] # å½“ main åˆ†æ”¯æœ‰æŽ¨é€æ—¶è§¦å‘
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: macos-15 # ä½¿ç”¨æœ€æ–°çš„ macOS çŽ¯å¢ƒ
    
    steps:
      - name: Checkout project
        uses: actions/checkout@v4

      # 1. å®‰è£…è¯ä¹¦å’Œæè¿°æ–‡ä»¶ (ä¿®å¤äº†è§£ç å‚æ•°æŠ¥é”™é—®é¢˜)
      - name: Install the Apple certificate and provisioning profile
        env:
          P12_BASE64: ${{ secrets.P12_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          PROVISIONING_BASE64: ${{ secrets.PROVISIONING_BASE64 }}
        run: |
          # å®šä¹‰é’¥åŒ™æ‰£è·¯å¾„
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 21)

          # åˆ›å»ºä¸´æ—¶é’¥åŒ™æ‰£
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # å¯¼å…¥ P12 è¯ä¹¦ (æ·»åŠ  --ignore-garbage é˜²æ­¢ Base64 æ ¼å¼é”™è¯¯)
          echo "$P12_BASE64" | base64 --decode --ignore-garbage > $RUNNER_TEMP/cert.p12
          
          # æ‰§è¡Œå¯¼å…¥ï¼šæ˜Žç¡®æŒ‡å®šé’¥åŒ™æ‰£è·¯å¾„
          security import $RUNNER_TEMP/cert.p12 -k "$KEYCHAIN_PATH" -P "$P12_PASSWORD" -T /usr/bin/codesign -T /usr/bin/productsign
          
          # è®¾ç½®åˆ†åŒºæƒé™åˆ—è¡¨ï¼Œé˜²æ­¢æ‰“åŒ…æ—¶å¼¹å‡ºæƒé™å¼¹çª—æŒ‚èµ·
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # å¯¼å…¥æè¿°æ–‡ä»¶
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$PROVISIONING_BASE64" | base64 --decode --ignore-garbage > ~/Library/MobileDevice/Provisioning\ Profiles/temp.mobileprovision
          
          # å°†é’¥åŒ™æ‰£è·¯å¾„å­˜å…¥çŽ¯å¢ƒå˜é‡ï¼ŒåŽç»­æ­¥éª¤éœ€è¦å¼•ç”¨
          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV

      # 2. è®¾ç½®é¡¹ç›®å˜é‡
      - name: Prepare Build Variables
        run: |
          PROJECT_PATH=$(ls -d *.xcodeproj | head -n 1)
          PROJECT_NAME=$(basename "$PROJECT_PATH" .xcodeproj)
          SCHEME_NAME=$(xcodebuild -list -json -project "$PROJECT_PATH" | python3 -c 'import json, sys; d = json.load(sys.stdin); s = d.get("project", {}).get("schemes", []); print(s[0] if s else "")')
          NEW_BUILD_NUMBER=$(date +"%Y%m%d%H%M")
          
          echo "PROJECT_PATH=$PROJECT_PATH" >> $GITHUB_ENV
          echo "PROJECT_NAME=$PROJECT_NAME" >> $GITHUB_ENV
          echo "SCHEME_NAME=$SCHEME_NAME" >> $GITHUB_ENV
          echo "NEW_BUILD_NUMBER=$NEW_BUILD_NUMBER" >> $GITHUB_ENV

      # 3. æ›´æ–° Build å·
      - name: Update Build Number
        run: |
          xcrun agvtool new-version -all "$NEW_BUILD_NUMBER"

      # 4. Archive å¹¶æž„å»º (å¢žåŠ  OTHER_CODE_SIGN_FLAGS æŒ‡å‘ç‰¹å®šé’¥åŒ™æ‰£)
      - name: Build Archive
        run: |
          xcodebuild archive \
            -project "${{ env.PROJECT_PATH }}" \
            -scheme "${{ env.SCHEME_NAME }}" \
            -configuration Release \
            -sdk iphoneos \
            -archivePath ./build/${{ env.PROJECT_NAME }}.xcarchive \
            -allowProvisioningUpdates \
            OTHER_CODE_SIGN_FLAGS="--keychain ${{ env.KEYCHAIN_PATH }}"

      # 5. å¯¼å‡º IPA
      - name: Export IPA
        run: |
          xcodebuild -exportArchive \
            -archivePath ./build/${{ env.PROJECT_NAME }}.xcarchive \
            -exportPath ./build/ipa \
            -exportOptionsPlist ./exportOptions.plist \
            -allowProvisioningUpdates

      # 6. ä¸Šä¼ åˆ°è’²å…¬è‹±
      - name: Upload to Pgyer
        env:
          PGY_API_KEY: ${{ secrets.PGY_API_KEY }}
          PGY_USER_KEY: ${{ secrets.PGY_USER_KEY }}
        run: |
          IPA_PATH=$(find ./build/ipa -name "*.ipa" | head -n 1)
          if [ -z "$IPA_PATH" ]; then
            echo "âŒ IPA not found!"
            exit 1
          fi
          
          echo "ðŸš€ Uploading $IPA_PATH to Pgyer..."
          RESPONSE=$(curl -s -F "file=@${IPA_PATH}" \
               -F "uKey=${PGY_USER_KEY}" \
               -F "_api_key=${PGY_API_KEY}" \
               https://www.pgyer.com/apiv2/app/upload)
               
          echo "Pgyer Response: $RESPONSE"
          DOWNLOAD_URL=$(echo "$RESPONSE" | python3 -c 'import sys, json; print(json.load(sys.stdin)["data"]["buildShortcutUrl"])' 2>/dev/null)
          echo "ðŸŽ‰ App Uploaded! URL: https://www.pgyer.com/$DOWNLOAD_URL"
